## 7.5 网络服务与安全

在网络中，数据在服务器端和客户端之间传递，由于是明文传递的内容，一旦在网络被人监控，数据就可能一览无余地展现在中间的窃听者面前。为此
我们需要将数据加密后再进行网络传输，这样即使数据被截获或窃听，窃听者也无法知道数据的真实内容是什么。但是对于我们的**应用层协议**而言，如
HTTP、FTP等，我们仍然希望能够透明地处理数据，而无须操心**网络传输过程中**的安全问题。在网景公司的 NetScape 浏览器推出之初就提出了
SSL (Secure Sockets Layer , 安全套接层)。SSL 作为一种安全协议，它在**传输层**提供对网络连接加密的功能。**对于应用层而言，它是透明的**，
数据在传递到应用层之前就已经完成了加密和解密的过程。最初的 SSL 应用在 Web 上，被服务器端和浏览器端同时支持，随后 IETF 将其标准化，
称为 TLS (Transport Layer Security, 安全传输层协议)。

Node 在网络安全上提供了 3 个模块，分别为 crypto 、tls 、https 。其中 crypto 主要用于加密解密，SHA1、MD5 等加密算法都在其中有体现，
在这里我们不用再提。真正用于网络的是另外两个模块，tls 模块提供了与 net 模块类似的功能，区别在于它建立在 TLS/SSL 加密的 TCP 连接上。
对 https 而言，它完全与 http 模块接口一致，区别也仅在于它建立于安全的连接之上。

### 7.5.1 TLS/SSL

1. 密钥

TLS/SSL 是一个公钥/私钥的结构，它是一个非对称的结构，每个服务器端和客户端都有自己的公私钥。公钥用来加密要传输的数据，私钥用来解密接收到
的数据。公钥和私钥是配对的，通过公钥加密的数据，只有通过私钥才能解密，所以在建立安全传输之前，客户端和服务器端之间需要互换公钥。客户端
发送数据时要通过服务器端的公钥进行加密，服务器端发送数据时则需要客户端的公钥进行加密，如此才能完成加密解密的过程，如图7-8所示。

![](http://i.imgur.com/EZZApVU.png)

Node 在底层采用的是 openssl 实现 TLS/SSL 的，为此要生成公钥和私钥可以通过 openssl 完成。我们分别为服务器端和客户端生产私钥，如下所示：

    // 生成服务器端私钥
    $ openssl genrsa -out server.key 1024
    // 生成客户端私钥
    $ openssl genrsa -out client.key 1024

上述命令生成了两个1024位长的 RSA 私钥文件，我们可以通过它继续生成公钥，如下所示：

    $ openssl rsa -in server.key -pubout -out server.pem
    $ openssl rsa -in client.key -pubout -out client.pem

公私钥的非对称加密虽好，但是网络中依然可能存在窃听的情况，典型的例子是中间人攻击。客户端和服务器端在交换公钥的过程中，中间人对客户端扮演
服务器的角色，对服务器端扮演客户端的角色，因此客户端和服务器端几乎感受不到中间人的存在。为了解决这种问题，数据传输过程中还需要对得到的
公钥进行认证，以确认得到的公钥是出自目标服务器。如果不能保证这种认证，中间人可能会将伪造的站点响应给用户，从而造成经济损失。图 7-9 是
中间人攻击的示意图。

![](http://i.imgur.com/63xekVp.png)

为了解决这个问题， TLS/SSL 引入了数字证书来进行认证。与直接用公钥不同，数字证书中包含了服务器的名称和主机名、服务器的公钥、签名颁发机构
的名称、来自签名颁发机构的签名。在连接建立前，会通过证书中的签名确认收到的公钥是来自目标服务器的，从而产生信任关系。

2. 数字证书

为了确保我们的数据安全，现在我们引入了一个第三方：CA (Certificate Authority，数字证书认证中心)。CA 的作用是为站点颁发证书，且这个证书
中具有 CA 通过自己的公钥和私钥实现的签名。